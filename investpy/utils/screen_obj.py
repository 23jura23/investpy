COUNTRIES = {
    "United States": 5,
    "Argentina": 29,
    "Australia": 25,
    "Austria": 54,
    "Bahrain": 145,
    "Bangladesh": 47,
    "Belgium": 34,
    "Bosnia-Herzegovina": 174,
    "Botswana": 163,
    "Brazil": 32,
    "Bulgaria": 70,
    "Canada": 6,
    "Chile": 27,
    "China": 37,
    "Colombia": 122,
    "Costa Rica": 15,
    "Cote D'Ivoire": 78,
    "Croatia": 113,
    "Cyprus": 107,
    "Czech Republic": 55,
    "Denmark": 24,
    "Egypt": 59,
    "Euro Zone": 72,
    "Finland": 71,
    "France": 22,
    "Germany": 17,
    "Greece": 51,
    "Hong Kong": 39,
    "Hungary": 93,
    "Iceland": 106,
    "India": 14,
    "Indonesia": 48,
    "Iraq": 66,
    "Ireland": 33,
    "Israel": 23,
    "Italy": 10,
    "Jamaica": 119,
    "Japan": 35,
    "Jordan": 92,
    "Kazakhstan": 102,
    "Kenya": 57,
    "Kuwait": 94,
    "Lebanon": 68,
    "Luxembourg": 103,
    "Malawi": 111,
    "Malaysia": 42,
    "Malta": 109,
    "Mauritius": 188,
    "Mexico": 7,
    "Mongolia": 139,
    "Montenegro": 247,
    "Morocco": 105,
    "Namibia": 172,
    "Netherlands": 21,
    "New Zealand": 43,
    "Nigeria": 20,
    "Norway": 60,
    "Oman": 87,
    "Pakistan": 44,
    "Palestinian Territory": 193,
    "Peru": 125,
    "Philippines": 45,
    "Poland": 53,
    "Portugal": 38,
    "Qatar": 170,
    "Romania": 100,
    "Russia": 56,
    "Rwanda": 80,
    "Saudi Arabia": 52,
    "Serbia": 238,
    "Singapore": 36,
    "Slovakia": 90,
    "Slovenia": 112,
    "South Africa": 110,
    "South Korea": 11,
    "Spain": 26,
    "Sri Lanka": 162,
    "Sweden": 9,
    "Switzerland": 12,
    "Taiwan": 46,
    "Tanzania": 85,
    "Thailand": 41,
    "Tunisia": 202,
    "Turkey": 63,
    "Uganda": 123,
    "Ukraine": 61,
    "United Arab Emirates": 143,
    "United Kingdom": 4,
    "Venezuela": 138,
    "Vietnam": 178,
    "Zambia": 84,
    "Zimbabwe": 75,

}
SECTORS = {
    "Basic Materials": 7,
    "Capital Goods": 5,
    "Conglomerates": 12,
    "Consumer Cyclical": 3,
    "Consumer/Non-Cyclical": 8,
    "Energy": 9,
    "Financial": 1,
    "Healthcare": 6,
    "Services": 2,
    "Technology": 4,
    "Transportation": 10,
    "Utilities": 11,
}

INDUSTRIES = {
    "Advertising ": 81,
    "Aerospace & Defense ": 56,
    "Air Courier ": 59,
    "Airline ": 41,
    "Apparel/Accessories ": 68,
    "Appliance & Tool ": 67,
    "Audio & Video Equipment ": 88,
    "Auto & Truck Manufacturers ": 51,
    "Auto & Truck Parts ": 72,
    "Beverages (Alcoholic) ": 47,
    "Beverages (Nonalcoholic) ": 12,
    "Biotechnology & Drugs ": 8,
    "Broadcasting & Cable TV ": 50,
    "Business Services ": 2,
    "Casinos & Gaming ": 71,
    "Chemical Manufacturing ": 9,
    "Chemicals - Plastics & Rubber ": 69,
    "Coal ": 45,
    "Communications Equipment ": 46,
    "Communications Services ": 13,
    "Computer Hardware ": 94,
    "Computer Networks ": 102,
    "Computer Peripherals ": 95,
    "Computer Services ": 58,
    "Computer Storage Devices ": 100,
    "Conglomerates ": 101,
    "Constr. & Agric. Machinery ": 87,
    "Constr. - Supplies & Fixtures ": 31,
    "Construction - Raw Materials ": 6,
    "Construction Services ": 38,
    "Consumer Financial Services ": 79,
    "Containers & Packaging ": 30,
    "Crops ": 77,
    "Electric Utilities ": 28,
    "Electronic Instr. & Controls ": 5,
    "Fabricated Plastic & Rubber ": 60,
    "Fish/Livestock ": 18,
    "Food Processing ": 26,
    "Footwear ": 44,
    "Forestry & Wood Products ": 35,
    "Furniture & Fixtures ": 53,
    "Gold & Silver ": 48,
    "Healthcare Facilities ": 49,
    "Hotels & Motels ": 55,
    "Insurance (Accident & Health) ": 78,
    "Insurance (Life) ": 7,
    "Insurance (Miscellaneous) ": 86,
    "Insurance (Prop. & Casualty) ": 10,
    "Investment Services ": 1,
    "Iron & Steel ": 34,
    "Jewelry & Silverware ": 3,
    "Major Drugs ": 11,
    "Medical Equipment & Supplies ": 62,
    "Metal Mining ": 16,
    "Misc. Capital Goods ": 24,
    "Misc. Fabricated Products ": 20,
    "Misc. Financial Services ": 54,
    "Misc. Transportation ": 33,
    "Mobile Homes & RVs ": 83,
    "Money Center Banks ": 29,
    "Motion Pictures ": 76,
    "Natural Gas Utilities ": 37,
    "Non-Metallic Mining ": 90,
    "Office Equipment ": 85,
    "Office Supplies ": 82,
    "Oil & Gas - Integrated ": 22,
    "Oil & Gas Operations ": 14,
    "Oil Well Services & Equipment ": 17,
    "Paper & Paper Products ": 19,
    "Personal & Household Prods. ": 43,
    "Personal Services ": 89,
    "Photography ": 96,
    "Printing & Publishing ": 57,
    "Printing Services ": 84,
    "Railroads ": 93,
    "Real Estate Operations ": 27,
    "Recreational Activities ": 74,
    "Recreational Products ": 97,
    "Regional Banks ": 4,
    "Rental & Leasing ": 73,
    "Restaurants ": 36,
    "Retail (Apparel) ": 42,
    "Retail (Catalog & Mail Order) ": 98,
    "Retail (Department & Discount) ": 65,
    "Retail (Drugs) ": 70,
    "Retail (Grocery) ": 40,
    "Retail (Home Improvement) ": 99,
    "Retail (Specialty) ": 39,
    "Retail (Technology) ": 92,
    "Schools ": 75,
    "Scientific & Technical Instr. ": 66,
    "Security Systems & Services ": 63,
    "Semiconductors ": 21,
    "S&Ls/Savings Banks ": 25,
    "Software & Programming ": 64,
    "Textiles - Non Apparel ": 61,
    "Tires ": 32,
    "Tobacco ": 91,
    "Trucking ": 52,
    "Waste Management Services ": 23,
    "Water Transportation ": 15,
    "Water Utilities ": 80,
}

EQUITY_TYPES = [
    "ORD",
    "DRC",
    "Preferred",
    "Unit",
    "ClosedEnd",
    "REIT",
    "ELKS",
    "OpenEnd",
    "Right",
    "ParticipationShare",
    "CapitalSecurity",
    "PerpetualCapitalSecurity",
    "GuaranteeCertificate",
    "IGC",
    "Warrant",
    "SeniorNote",
    "Debenture",
    "ETF",
    "ADR",
    "ETC",
    "ETN"
]

FILTERS = {
    "Dividend": "eq_dividend",
    "Dividend Yield": "yield_us",
    "Dividend Yield 5YA": "yld5yavg_us",
    "Dividend Growth Rate (ANN)": "divgrpct_us",
    "Payout Ratio (TTM)": "ttmpayrat_us",
    "EPS": "eq_eps",
    "P/E Ratio (TTM)": "peexclxor_us",
    "Price to Sales (TTM)": "ttmpr2rev_us",
    "Price to Cash Flow (MRQ)": "aprfcfps_us",
    "Price to Free Cash Flow (TTM)": "ttmprfcfps_us",
    "Price to Book (MRQ)": "price2bk_us",
    "Price to Tangible Book (MRQ)": "pr2tanbk_us",
    "EPS(MRQ) vs Qtr. 1 Yr. Ago": "epschngyr_us",
    "EPS(TTM) vs TTM 1 Yr. Ago": "ttmepschg_us",
    "5 Year EPS Growth": "epstrendgr_us",
    "Sales (MRQ) vs Qtr. 1 Yr. Ago": "revchngyr_us",
    "Sales (TTM) vs TTM 1 Yr. Ago (TTM)": "ttmrevchg_us",
    "5 Year Sales Growth": "revtrendgr_us",
    "5 Year Capital Spending Growth": "csptrendgr_us",
    "Asset Turnover (TTM)": "ttmastturn_us",
    "Inventory Turnover (TTM)": "ttminvturn_us",
    "Revenue/Employee (TTM)": "ttmrevpere_us",
    "Net Income/Employee (TTM)": "ttmniperem_us",
    "Receivable Turnover (TTM)": "ttmrecturn_us",
    "P/E Ratio": "eq_pe_ratio",
    "Market Cap": "eq_market_cap",
    "1-Year Change": "eq_one_year_return",
    "Average Vol. (3m)": "avg_volume",
    "Last": "last",
    "Daily Change (%)": "pair_change_percent",
    "52 wk Range - High": "a52_week_high",
    "52 wk Range - Low": "a52_week_low",
    "% Change from 52 wk High": "a52_week_high_diff",
    "% Change from 52 wk Low": "a52_week_low_diff",
    "YTD % Return": "ytd",
    "Previous Month % Change": "month_change",
    "Volume": "turnover_volume",
    "Beta": "eq_beta",
    "Revenue": "eq_revenue",
    "Gross margin (TTM)": "ttmgrosmgn_us",
    "Gross Margin (5YA)": "grosmgn5yr_us",
    "Operating margin (TTM)": "ttmopmgn_us",
    "Operating margin (5YA)": "opmgn5yr_us",
    "Pretax margin (TTM)": "ttmptmgn_us",
    "Pretax margin (5YA)": "ptmgn5yr_us",
    "Net Profit margin (TTM)": "ttmnpmgn_us",
    "Net Profit margin (5YA)": "margin5yr_us",
    "Quick Ratio (MRQ)": "qquickrati_us",
    "Current Ratio (MRQ)": "qcurratio_us",
    "LT Debt to Equity (MRQ)": "qltd2eq_us",
    "Total Debt to Equity": "qtotd2eq_us",
    "ADX (14 / 1D)": "ADX",
    "ATR (14 / 1D)": "ATR",
    "Bull/Bear Power (13 / 1D)": "BullBear",
    "CCI (14 / 1D)": "CCI",
    "Highs/Lows (14 / 1D)": "HL",
    "MACD (12,26 / 1D)": "MACD",
    "ROC (1D)": "ROC",
    "RSI (14 / 1D)": "RSI",
    "STOCH (14 / 1D)": "STOCH",
    "STOCHRSI (14 / 1D)": "STOCHRSI",
    "Ultimate Oscillator (14 /1D)": "UO",
    "Williams %R (1D)": "WilliamsR",
}


class ScreenerParams(object):
    """
    Return a new screener parameter builder.

    You build up the parameters for the stock screener by using the methods in this class.

    For example, to get all stocks in Spain with a market cap between EUR 20m and EUR 100m, with a P/E ratio under 20:

    ```
    params = ip.ScreenerParams() \
    .with_country("Spain") \
    .add_equity_type("ORD") \
    .add_filter("P/E Ratio (TTM)", 0, 20)
    ```

    This object can be passed to the `screener()` function to retrieve the results
    """
    def __init__(self):
        self.country = 'United States'
        # The set of valid exchanges depends on the country, so use all exchanges for now
        self.exchange = -1
        self.sectors = []
        self.industries = []
        self.equity_types = []
        self.filters = {}

    """
    Return a list of all valid sectors for the `add_sector` method        
    """
    def all_sectors(self):
        return SECTORS.keys()

    """
    Returns a list of all avilable countries
    """
    def all_countries(self):
        return COUNTRIES.keys()

    """
    Returns a list of all valid industry classes for the `add_industry` method
    """
    def all_industries(self):
        return INDUSTRIES.keys()

    """
    Returns a list of all valid equity types for the `add_equity_type` method
    """
    def all_equity_types(self):
        return EQUITY_TYPES

    """
    Returns a list of all valid filters for the `add_filter` method
    """
    def all_filters(self):
        return FILTERS.keys()

    """
    Define the country to use in the screener. 
    
    Calling this method twice will overwrite the country filter.
    
    The default value is "United States" if you do not use this method.
    
    To see a list of valid countries, use `all_countries`
    """
    def with_country(self, country):
        if not country:
            raise ValueError("ERR#0039: country can not be None, it should be a str.")
        if not country in COUNTRIES.keys():
            raise ValueError("ERR#00??: %s is not a valid country")
        self.country = country
        return self

    """
    Add a sector to use in the screener. 
    
    Calling this method multiple times will add the sector to the list to retrieve.
    The default is to search all sectors.
    
    To see a list of valid sectors, use `all_sectors`
    """
    def add_sector(self, sector):
        if not sector:
            raise ValueError("ERR#00??: sector can not be None, it should be a str.")
        if not sector in SECTORS.keys():
            raise ValueError("ERR#00??: %s is not a valid sector")

        self.sectors.append(sector)
        return self

    """
    Add an industry to use in the screener. 
    
    Calling this method multiple times will add the industry to the list to retrieve.
    The default is to search all industries.
    
    To see a list of valid industries, use `all_industries`
    """
    def add_industry(self, industry):
        if not industry:
            raise ValueError("ERR#00??: industry can not be None, it should be a str.")
        if not industry in INDUSTRIES.keys():
            raise ValueError("ERR#00??: %s is not a valid industry")

        self.industries.append(industry)
        return self

    """
    Add an equity type to use in the screener. 
    
    Calling this method multiple times will add the equity type to the list to retrieve.
    The default is to search all equity types.
    
    To see a list of valid equity types, use `all_equity_types`
    """
    def add_equity_type(self, equity_type):
        if not equity_type:
            raise ValueError("ERR#00??: equity_type can not be None, it should be a str.")
        if not equity_type in EQUITY_TYPES:
            raise ValueError("ERR#00??: %s is not a valid equity_type")

        self.equity_types.append(equity_type)
        return self

    """
    Add a filter to use in the screener. 
    
    Calling this method multiple times will add the filter to the list to retrieve.
    
    Each filter requires a minimum and a maximum value to use to search the stocks.
    
    To see a list of valid filters, use `all_filters`
    """
    def add_filter(self, filter, min=0.0, max=100.0):
        if not filter:
            raise ValueError("ERR#00??: filter can not be None, it should be a str.")
        if not filter in FILTERS.keys():
            raise ValueError("ERR#00??: %s is not a valid filter")
        self.filters[filter] = {"min": min, "max": max}
        return self

    """
        Builds the request form object using the values in the builder. You don't have
        to call tis method yourself. It is used in the `screener` to build the parameters
        for the query to Investing.com's stock screener tool.
    """
    def finish(self):
        data = {}
        data["country[]"] = COUNTRIES[self.country]

        data["sector"] = join_arr(self.sectors, SECTORS)
        data["industry"] = join_arr(self.industries, INDUSTRIES)
        data["equityType"] = join_equities(self.equity_types)
        # data["exchange[]"] is omitted for all exchanges
        data["order[col]"] = 'name_trans'
        data["order[dir]"] = 'a'
        data["pn"] = 1
        build_filters(data, self.filters)
        return data

def join_arr(arr, dict):
    if len(arr) == 0:
        entries = [str(v) for v in dict.values()]
    else:
        entries = [str(dict[v]) for v in arr]
    return ",".join(entries)

def join_equities(arr):
    entries = EQUITY_TYPES if len(arr) == 0 else arr
    return ",".join(entries)

def build_filters(data, filters):
    for filter in filters:
        key = FILTERS[filter]
        data["%s[min]" % (key,)] = filters[filter]["min"]
        data["%s[max]" % (key,)] = filters[filter]["max"]

